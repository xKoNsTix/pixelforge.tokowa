!function(e){"use strict";e.AviaElementBehavior=e.AviaElementBehavior||{},e.AviaElementBehavior.wp_media=e.AviaElementBehavior.wp_media||[],e.AviaElementBehavior.wp_media_advanced=function(){var i=e("body"),a=[],t=wp.media;i.on("click",".avia-builder-prev-img-container a, .avia-builder-prev-img>img",function(i){i.preventDefault();var a=e(this).parents(".avia-form-element-container").eq(0);if(a.hasClass("avia-locked-input-element"))return!1;a.find(".button").eq(0).trigger("click")}),i.on("click",".avia-element-image .avia-delete-image",function(i){i.preventDefault();var a=e(this).addClass("avia-hidden").parents(".avia-form-element-container").eq(0);a.find(".avia-builder-prev-img").html(""),a.find("input[type=hidden]").val("").trigger("change")}),i.on("click",".avia-delete-gallery-button",function(i){i.preventDefault();var a=e(this).parents(".avia-form-element-container").eq(0);a.find(".avia-builder-prev-img-container").html(""),a.find("input[type=hidden]").val("").trigger("change")}),i.on("click",".avia-element-action_button.avia-save_video_thumbnails .button",function(i){i.preventDefault();var a=e(this),t=e('<div class="ajax_load"><span class="ajax_load_inner"></span></div>'),l=e(".avia-modal .avia-element-video .avia-form-element input").val(),r=a.data("post_id");({saveVideoThumbs:function(){e.ajax({type:"POST",url:ajaxurl,data:{action:"avia_save_video_thumbnails_locally",post_id:r,video_url:l,_ajax_nonce:e("#avia-loader-nonce").val()},beforeSend:function(){t.insertAfter(a),a.addClass("avia_button_inactive"),e(".avia-notification").remove()},error:function(i){var l="";l=void 0!==i.responseJSON?i.responseJSON.data[0].message:"Internal Server Error - File could not be downloaded.",e('<div class="avia-notification avia-notification-error"><p>'+l+"</p></div>").insertAfter(a),t.remove(),a.removeClass("avia_button_inactive")},success:function(i){e('<div class="avia-notification avia-notification-success"><p>'+i.message+"</p></div>").insertAfter(a)}}).done(function(){t.remove(),a.removeClass("avia_button_inactive")})}}).saveVideoThumbs()}),i.on("click",".aviabuilder-image-upload",function(i){i.preventDefault();var l=e(this),r=l.data(),n=l.closest(".avia-modal-group-wrapper");0==n.length&&(n=l.closest(".avia-form-element-container"));var o=n.find("#"+r.target),d=o.next("input"),s=n.find(".hidden-attachment-id"),v=n.find(".hidden-attachment-size"),p=n.find(".avia-builder-prev-img-container"),u=n.find(".avia-tmpl-modal-element"),m=u.html(),c=n.find(".avia-modal-group"),f=n.find(".avia-delete-image"),g=function(i,a,t){var l=[],r="image";if("html"==t.save_to)a.each(function(){var i=e(this).html();isNaN(parseInt(i,10))||l.push(i)});else{if(void 0===i)return;l=i.split(",")}if(0!=l.length&&!isNaN(parseInt(l[0],10))){void 0!==t.media_type&&(r=t.media_type);var n={orderby:"post__in",order:"ASC",type:r,perPage:-1,post__in:l},o=wp.media.query(n),d=new wp.media.model.Selection(o.models,{props:o.props.toJSON(),multiple:!0});return void 0!==t.state_edit&&l.length>0&&(t.state=t.state_edit),d}}(o.val(),s,r),b=_.random(0,1e18);e.AviaElementBehavior.wp_media.unshift(this),a[b]?a[b].open():(a[b]=wp.media({frame:r.frame,state:r.state,library:{type:"image"},button:{text:r.button},className:r.class,selection:g}),a[b].states.add([new t.controller.Library({id:"avia_insert_single",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query(a[b].options.library),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new t.controller.Library({id:"avia_insert_multi",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query(a[b].options.library),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!1,allowLocalEdits:!0}),new t.controller.Library({id:"avia_insert_video",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query({type:"video",orderby:"date",query:!0}),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new t.controller.Library({id:"avia_insert_multi_video",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query({type:"video",orderby:"date",query:!0}),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new t.controller.Library({id:"avia_insert_audio",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query({type:"audio",orderby:"date",query:!0}),multiple:!1,editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0}),new t.controller.Library({id:"avia_insert_multi_audio",title:l.data("title"),priority:20,toolbar:"select",filterable:"uploaded",library:t.query({type:"audio",orderby:"date",query:!0}),multiple:"add",editable:!0,displayUserSettings:!1,displaySettings:!0,allowLocalEdits:!0})]),a[b].on("select update insert",function(i){var t,l=a[b].state();t=void 0!==i?i:l.get("selection");var n,g,_,h,y="",w=e("<div></div>");n=t.map(function(i){if(_=i.toJSON(),"url"==r.fetch)return g=l.display(i).toJSON(),void 0===_.sizes?(h=_.url,y=""):(h=_.sizes[g.size].url,y+="<span class='avia-builder-prev-img'><img src='"+h+"' /></span>",f.removeClass("avia-hidden"),s.length&&s.val(_.id),v.length&&v.val(g.size)),h;if("id"==r.fetch)return h=void 0!==_.sizes.thumbnail?_.sizes.thumbnail.url:_.url,y+="<span class='avia-builder-prev-img'><img src='"+h+"' /></span>",f.removeClass("avia-hidden"),d.length&&d.val('<img src="'+h+'" />'),_[r.fetch];if("template"==r.fetch){var a=e(m),t={id:_.id,img_fakeArg:""};if(u.hasClass("avia-copy-element-template")){a.addClass("avia-force-empty-update-value");var n=a.html().match(/element_template='(\d*)'|element_template="(\d*)"/i);null!=n&&n.length>1?t.element_template=n[1]:t.element_template=""}_.sizes&&_.sizes.thumbnail?t.img_fakeArg=_.sizes.thumbnail.url:t.img_fakeArg=_.url,t.img_fakeArg='<img src="'+t.img_fakeArg+'" title="" alt="" />';var o=e.avia_builder.update_builder_html(a,t,!1);a.find(e.avia_builder.datastorage).eq(0)[0].innerHTML=o.output,w.append(a)}else if("template_audio"==r.fetch){c.html(""),g=l.display(i).toJSON();a=e(m);(t={id:_.id,title:_.title,artist:_.artist,album:_.album,description:_.description,filelength:_.fileLength,url:_.url,filename:_.filename,icon:_.icon,img_fakeArg:_.icon,title_info:""}).img_fakeArg='<img src="'+t.img_fakeArg+'" title="'+t.title+'" alt="" />',void 0!==t.title?t.title_info+='<span class="avia-known-title">'+t.title:t.title_info+='<span class="avia-unknown-title">'+t.title,t.title_info+="</span>";o=e.avia_builder.update_builder_html(a,t,!0);a.find(e.avia_builder.datastorage).eq(0)[0].innerHTML=o.output,w.append(a)}}),o.length&&o.val(n.join(",")).trigger("change"),p.length&&p.html(y),c.length&&c.append(w.html())}),a[b].on("close",function(){_.defer(function(){e.AviaElementBehavior.wp_media.shift()})}),a[b].open())})}}(jQuery);